## Введение
Целью данного проекта выступает поиск способа использования raspberry pi в бытовых целях, принимая во внимание аппаратные ресурсы одноплатного компьютера с оглядкой на бытовые потребности можно сделать вывод, что устройство является оптимальным для создания домашнего сервера по следующим причинам:
1) Энергоэффективность - потребляемая мощность устройством от сети составляет 4 ватта, что от 25 раз меньше, чем в случае с вариантом использования аппаратных возможностей десктопного компьютера.
2) Производительность - для небольшого домашнего сервера не требуется больших аппаратных возможностей устройства.
3) Компактность - устройство имеет малые габариты, благодаря чему не занимает много места.
 
Для домашнего использования применимы следующие операционные системы:

• Pi-Hole – это сервер доменных имён, включающий в себя блокировку рекламы и трекеров на уровне DNS. Данная система имеет открытый исходный код. Из плюсов можно выделить удаление с интернет страниц рекламы и снижение нагрузки на сетевой канал за счёт выборочной загрузки данных. Выборность обусловлена отсеиванием лишних элементов. Для управления и настройки фильтрации доступен веб-интерфейс.

• CUPS – сервер печати. Данная система позволяет одновременно использовать обычный usb-принтер несколькими устройствами. Основным преимуществом такого решения является постоянная доступность принтера для любого домашнего устройства. Для администрирования CUPS имеет встроенный веб-интерфейс администрирования. Однако, существует также множество графических средств настройки CUPS. Например, среда GNOME содержит утилиту gnome-cups-manager, позволяющую администрировать CUPS, а в среде KDE используются средства администрирования, специфичные для различных дистрибутивов.

• Home assistant – данная операционная система является хост сервером умного дома. Данная система позволяет объединить в одну систему решения практически для всех компонентов Home Automation различных производителей. Также к её преимуществам можно отнести открытый исходный код, что позволяет разрабатывать плагины для взаимодействия с любым оборудованием и поддержку всех существующих стандартов управления умными устройствами. К недостаткам данной системы умного дома можно отнести необходимость установки домашнего сервера и требования к определенному уровню компетенции пользователя. Для управления данная система может оснащаться графическим интерфейсом, имеет веб-интерфейс и мобильное приложение.

После определения систем для установки необходимо определить способ организации работы нескольких серверов на одном аппаратном устройстве. Первоначально был рассмотрен вариант с использованием систем виртуализации. В частности, был рассмотрен вариант установки на raspberry Pi системы proxmox, которая имеет адаптацию под одноплатный компьютер именуемую pimox.
	Proxmox Virtual Environment — это система, предоставляющая веб-интерфейс для управления виртуальными машинами (используется KVM) и контейнерами (LXC) на вашем кластере физических машин.
Однако такой вариант организации системы оказался неэффективным по большей части из-за избыточной нагрузки на аппаратную часть, создаваемой системой виртуализации.
	Наиболее оптимальным вариантом стала установка основной серверной операционной системы и последующая установка на неё выбранных систем в формате приложений. В качестве основной системы была выбрана Ubuntu server. По причине простоты настройки, приемлемой нагрузки на аппаратное обеспечение и доступности всех плагинов, необходимых для организации подобных серверов.

В процессе работы над проектом потребуется выполнить следующие задачи:

1) Установить серверную операционную систему на Raspberry Pi.
2) Настроить SSH
3) Выполнить установку Pi-Hole и его настройку, связать с домашним роутером.
4) Установить и настроить CUPS
5) Осуществить установку Home Assistant, осуществить добавление умных устройств.

## Установка Ubuntu Server


Первым делом требуется обеспечить аппаратную часть программным комплексом. Для установки операционной системы необходимо отформатировать SD-карту в формате файловой системы FAT32.
После форматирования выполняется запись образа системы при помощи программы Raspberry Pi Imager
 

![image](https://user-images.githubusercontent.com/41922095/153766633-55475a40-9707-4ca8-ba19-3e9729252cde.png)

### Рисунок 1 – интерфейс Raspberry Pi Imager

После создания образа карта памяти устанавливается в одноплатный компьютер. В процессе установки требуется выбрать язык, раскладку клавиатуры, регион, часовой пояс.
Ubuntu server по умолчанию не имеет графической оболочки, что снижает нагрузку на аппаратную часть, однако управление системой осуществляется при помощи консольных команд. При первом включении необходимо выполнить первоначальную конфигурацию устройства. 

## Настройка SSH


После установки системы требуется настроить удалённое подключение для упрощения последующего конфигурирования и администрирования. Для этих целей можно использовать протоколы telnet, либо SSH. В данном случае был выбран протокол SSH, поскольку он является более безопасным.
Начнем с открытия окна терминала и ввода необходимых команд:

1.Пакет, необходимый для запуска SSH-сервера, предоставляется компонентом openssh-server из OpenSSH:

sudo apt install openssh-server

2.После завершения загрузки и установки пакета служба SSH должна быть уже запущена, для проверки статуса службы используется следующая команда:

service ssh status

3.Ubuntu поставляется с утилитой межсетевого экрана под названием UFW (UncomplicatedFirewall), которая представляет собой интерфейс для iptables, который, в свою очередь, управляет сетевыми правилами. Если брандмауэр активен, он может помешать подключению к SSH-серверу.

Чтобы настроить UFW так, чтобы он разрешал требуемый доступ, необходимо выполнить следующую команду:

sudo ufw allow ssh

Конфигурация на стороне сервера завершена. Перед установкой удалённого подключения выполним привязку статического IP к существующему mac-адресу устройства, это необходимо для того, чтобы устройство не получало разные ip-адреса по DHCP.


![image](https://user-images.githubusercontent.com/41922095/155372942-61c04fc1-e450-44c0-857f-88bdc577f34e.png)

### Рисунок 2 - настройка статического IP-адреса.

После настройки сатического IP-адреса выполним тестовое подключение. Подключение с компьютера осуществляется с помощью расширения Secure Shell для браузера Google Chrome.


![image](https://user-images.githubusercontent.com/41922095/155374511-1ab0967f-2965-4e72-a140-0b68af2057db.png)

### Рисунок 3 - удалённое подключение к серверу.

## Настройка удаленного сервера


Приступаем к конфигурированию удаленного сервера. Первым компонентом для установки является Pi-Hole. Перед его установкой требуется установить инструмент network manager, который позволяет осуществлять управление сетевым подключением. Для установки "Network manager" требуется ввести команду:

#### apt install network manager

После установки инструмента "Network manager" для установки Pi-Hole воспользуемся следующей командой:

#### curl -sSL https://install.pi-hole.net | bash

В конце установки у нас появится IP-адрес по которому будет доступен web-интерфейс для настройки компонента.


![2021-09-26_18-02-46](https://user-images.githubusercontent.com/41922095/160289508-34c17907-4cb1-4aed-aca8-96e2ca972575.png)

### Рисунок 4 - установка Pi-Hole.

После установки пакета необходимо добавить IP-адрес доступа на домашний роутер в качестве DNS сервера, чтобы он начал отправлять туда запросы.


![image](https://user-images.githubusercontent.com/41922095/160292939-59563cc4-458a-4fee-a088-a6329b300c62.png)

### Рисунок 5 - настройка роутера на работу с Pi-Hole

C помощью предоставленных в конце установки данных нужно подключиться к серверу для удалённой настройки. В web-интерфейсе можно настроить сервер доменных имён, используемый по умолчанию, заблокировать/разблокировать адреса сайтов. Обновить базу данных сервиса. Посмотреть статистику блокировок.


![image](https://user-images.githubusercontent.com/41922095/160292644-5a8de488-e108-41ff-8b6a-d2bcfeb65ba1.png)

### Рисунок 6 - панель управления Pi-Hole.

Для возможности печати с устройств находящихся в локальной сети установим CUPS - сервер печати. Для установки пакета нужно ввести команду:

#### sudo apt-get install cups avahi-daemon avahi-discover

По умолчанию CUPS уже имеет некоторый набор драйверов для работы с принтерами, но его также можно расширить с помощью ，библиотеки Foomatic， для её установки введём команду:

#### sudo apt-get install foomatic-db foomatic-db-engine

После установки добавим пользователя pi в группу lpadmin, позволяющую управлять принтерами:

#### sudo adduser pi lpadmin

Теперь необходимо отредактировать файл конфигурации, дело в том, что по умолчанию веб интерфейс управления доступен только с самой Raspberry. Для того чтобы это исправить нужно отредактировать любым доступным редактором cupsd.conf. Введём команду:

#### sudo nano /etc/cups/cupsd.conf

В открывшемся редакторе внесём следующие правки:


![rpicups-01](https://user-images.githubusercontent.com/41922095/161390883-73a488c8-1308-415a-bb4c-7c2eb7f5c649.jpg)

### Рисунок 7 - разрешение удалённого доступа.

Разрешим удаленное редактирование настроек:


![rpicups-02](https://user-images.githubusercontent.com/41922095/161390963-52b9179a-349b-44cc-a7c5-824d0cffa68b.png)

### Рисунок 8 - разрешение удалённого изменения конфигурации.

После редактирования можно перейти к подключению принтера, для этого введём в браузере IP-адрес и порт интерфейса устройства, в первую очередь нужно убедиться, что в настройках установлена галочка "разрешить совместный доступ к принтерам, подключенным к этой системе". После чего можно перейти к добавлению принтера. Сама настройка выполняется простым способом:

![image](https://user-images.githubusercontent.com/41922095/161392191-5ee59cae-6d13-4abc-b5ba-54be290e30a3.png)

### Рисунок 9 - выбор принтера.


![image](https://user-images.githubusercontent.com/41922095/161392125-eb3b06f2-b44b-498c-a5c1-9564287901c2.png)

### Рисунок 10 - выбор драйвера.

Последним пакетом, установленным на домашний сервер будет Home Assistant. Данный пакет позволяет организовать сервер умного дома.
В первую очередь для установки Home assistant потребуется загрузить систему контейнерной оркестрации Docker, для этого выполним команды:

#### curl -fsSL https://get.docker.com -o get-docker.sh
#### sudo sh get-docker.sh


![2021-09-26_18-04-47](https://user-images.githubusercontent.com/41922095/161393734-87bb8121-854d-4437-9a4c-22068a0d701c.png)

### Рисунок 11 - установка Docker.


![2021-09-26_18-05-22](https://user-images.githubusercontent.com/41922095/161393819-0a21cdfb-9b2f-49c7-8d90-ad589a682f46.png)

### Рисунок 12 - запуск скрипта

Установим отсутствующие пакеты:

#### sudo apt install jq 


![2021-09-26_18-11-24](https://user-images.githubusercontent.com/41922095/161394221-f91d2a2b-0fe1-4c3f-b85c-c62f698f3c59.png)

### Рисунок 13 - установка пакета jq.

Теперь нужно установить сам Home Assistant, для этого вводим команду:

#### curl -Lo installer.sh https://raw.githubusercontent.com/home-assistant/supervised-installer/master/installer.sh


![2021-09-26_18-14-50](https://user-images.githubusercontent.com/41922095/161394377-9d8e4dd1-5ea1-4fec-88a1-a3209a5bcce0.png)

### Рисунок 14 - установка пакета Home Assistant.

Запустим установленный компонент:

#### bash installer.sh —machine raspberrypi4-64


![2021-09-26_18-16-04](https://user-images.githubusercontent.com/41922095/161394443-05c76a24-52d5-4e1c-b9f5-473717562afd.png)

### Рисунок 15 - запуск скрипта

После выполнения установки веб-интерфейс системы будет доступен по IP-адресу сервера, по умолчанию используется порт 8123.


![Home Assistant](https://user-images.githubusercontent.com/41922095/161394752-12641eca-abfb-422d-92e9-2ebf5419f6b0.PNG)

### Рисунок 16 - веб-интерфейс Home Assistant.

Рассмотрим добавление устройств в Home Assistant на примере робота пылесоса Xiaomi. После входа на веб-интерфейс сервера нужно воспользовавшись встроенной библиотекой компонентов установить компонент HACS.
Добавление нужной интеграции с помощью HACS выглядит следующим образом:

- Заходим в HACS и переходим в раздел “Интеграции”.
- Нажимаем на три точки в правом верхнем углу и выбираем “Пользовательские репозитории”.


![image](https://user-images.githubusercontent.com/41922095/161396912-acbdcd77-56cf-48a6-9901-0c0126d14d69.png)

### Рисунок 17 - пользовательские репозитории.

- В качестве категории выбираем “интеграция” и прописываем путь https://github.com/Concentricc/xiaomi_vacuum/
- Сразу же появится новая интеграция, которую нужно установить.


![image](https://user-images.githubusercontent.com/41922095/161396990-76af4b3e-4ef3-420c-818d-3b7afc2f7e1f.png)

### Рисунок 18 - установка интеграции

- Перезапускаем сервер после установки.
- После перезагрузки пылесос появится в общем списке объектов.


![Xiaomi-Vacuum-Home-Assistant](https://user-images.githubusercontent.com/41922095/161397369-019b3844-8436-4db6-913b-5209d8f578fc.jpg)

### Рисунок 19 - список объектов

Теперь добавим карточку объекта в Lovelace, для этого переходим в HACS –> Пользовательский интерфейс и нажимаем “Explore & add repositories”.


![Add-repositories-768x372](https://user-images.githubusercontent.com/41922095/161397514-46e1b8e5-e28e-474b-948a-51a3d62633f0.jpg)

### Рисунок 20 - меню пользовательского интерфейса.

Здесь необходимо найти Vacuum Card, затем выбрать “Установить этот репозиторий в HACS”.


![image](https://user-images.githubusercontent.com/41922095/161397574-3e19a75f-6b7a-4b53-b379-a0f3f1e01591.png)

### Рисунок 21 - добавление карточки

Чтобы не получить ошибку “Custom element doesn’t exist: vacuum-card”, прописываем в configuration.yaml после mode: yaml указал путь до карточки и перезагружаем Home Assistant:

#### lovelace:
####   mode: yaml
####   resources:
####     - url: /local/community/vacuum-card/vacuum-card.js
####       type: module

Получившаяся карточка будет иметь следующий вид:


![image](https://user-images.githubusercontent.com/41922095/161397688-ea8d5943-1b3f-4bad-a1b1-f726dedf144a.png)

### Рисунок 22 - карточка объекта

В качестве второго примера выполним добавление умного чайника Redmond G212S. Для добавления устройства потребуется шлюз redmond, либо arduino на которых будет установлена кастомная прошивка, для этого необходимо воспользоваться утилитой Flash Download Tools. После запуска программы откроется 2 интерфейса, в первом запустится основной интерфейс, во втором командная строка. В основном интерфейсе следует выбрать "Developer mode".


![image](https://user-images.githubusercontent.com/41922095/169700637-e7076888-d545-4f7e-857f-f4719ff26ddd.png)

### Рисунок 23 - основной интерфейс

В следующем окне перейти в раздел ESP32 DownloadTool.


![image](https://user-images.githubusercontent.com/41922095/169700746-d5f1e500-6fd1-4ca7-b3e3-2252c7a0e891.png)

### Рисунок 24 - выбор ESP32 DownloadTool

В новом окне нужно добавить файл прошивки, взять который можно по ссылке (https://github.com/alutov/ESP32-R4sGate-for-Redmond)
А также выставить параметры в соответствии с прошиваемой платой и определить COM-порт.


![image](https://user-images.githubusercontent.com/41922095/169700892-e3e68b53-aac7-414d-a2c1-40746c510483.png)

### Рисунок 25 - окно настроек и выбора прошивки

После перепрошивки устанавливаем плату с ESP32 около чайника, включаем в розетку. Контроллер будет ждать появления wi-fi сети "r4s" и паролем "12345678". Необходимо создать гостевую сеть с такими параметрами или раздать wifi с телефона. Далее необходимо проверить, какой адрес получил модуль esp32 и заходим через браузер на этот адрес.


![image](https://user-images.githubusercontent.com/41922095/169701452-7f7e1b3b-0039-463a-90dd-abaedd854055.png)

### Рисунок 26 - интерфейс шлюза после перепрошивки

Далее необходимо перейти на вкладку настройки и указать wifi-сеть для подключения и пароль к ней. Дополнительно можно сразу прописать адрес mqtt брокера. Теперь нужно перевести чайник в режим сопряжения зажав кнопку включения на 5 секунд. Далее необходимо указать имя устройства на вкладке настроек (необходимо посмотреть как он видится с помощью bluetooth, для этого на главной странице есть строка "BLE last found device name") и указать его тип.


![image](https://user-images.githubusercontent.com/41922095/169701611-74eceb12-e610-4722-b016-899b8d071562.png)

### Рисунок 27 - тип устройства

При успешном подключении на главной странице интерфейса появится уровень сигнала BLE и статус подключения чайника.


![image](https://user-images.githubusercontent.com/41922095/169701686-6a4ccf44-2529-4604-a3d5-b406e854b101.png)

### Рисунок 28 - главная страница Web-интерфейса

После выполнения всех вышеперечисленных работ в интерфейсе home assistant появятся новые объекты:
Первое - уровень сигнала wi-fi на шлюзе.


![image](https://user-images.githubusercontent.com/41922095/169701849-69bedf22-82a0-4d1d-8ce1-05cc25901645.png)

### Рисунок 29 - уровень сигнала wi-fi

Второе - управление самим чайником


![image](https://user-images.githubusercontent.com/41922095/169701903-031f56b9-e1f3-41d9-b232-d0d81cfe5114.png)

### Рисунок 30 - управление чайником

